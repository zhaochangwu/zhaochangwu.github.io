<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="单例模式 － Singleton单例模式确保每个指定的类只存在一个实例对象，并且可以全局访问那个实例 产生的背景／解决的问题 某个类经常被使用，避免其被频繁的创建销毁 共享数据，如NSUserDefault进行本地化  主要结构  这是一个日志类，有一个属性 (是一个单例对象) 和两个方法 (sharedInstance() 和 init())。第一次调用 sharedInstance() 的时候">
<meta name="keywords" content="iOS,Singleton">
<meta property="og:type" content="article">
<meta property="og:title" content="Singleton of iOS">
<meta property="og:url" content="http://yoursite.com/2016/07/10/Singleton/index.html">
<meta property="og:site_name" content="这是一个程序猿的博客">
<meta property="og:description" content="单例模式 － Singleton单例模式确保每个指定的类只存在一个实例对象，并且可以全局访问那个实例 产生的背景／解决的问题 某个类经常被使用，避免其被频繁的创建销毁 共享数据，如NSUserDefault进行本地化  主要结构  这是一个日志类，有一个属性 (是一个单例对象) 和两个方法 (sharedInstance() 和 init())。第一次调用 sharedInstance() 的时候">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/images/Singleton/Singleton_1.png">
<meta property="og:image" content="http://yoursite.com/images/Singleton/Singleton_2.png">
<meta property="og:image" content="http://yoursite.com/images/Singleton/Singleton_3.png">
<meta property="og:updated_time" content="2018-07-31T02:46:41.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Singleton of iOS">
<meta name="twitter:description" content="单例模式 － Singleton单例模式确保每个指定的类只存在一个实例对象，并且可以全局访问那个实例 产生的背景／解决的问题 某个类经常被使用，避免其被频繁的创建销毁 共享数据，如NSUserDefault进行本地化  主要结构  这是一个日志类，有一个属性 (是一个单例对象) 和两个方法 (sharedInstance() 和 init())。第一次调用 sharedInstance() 的时候">
<meta name="twitter:image" content="http://yoursite.com/images/Singleton/Singleton_1.png">






  <link rel="canonical" href="http://yoursite.com/2016/07/10/Singleton/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Singleton of iOS | 这是一个程序猿的博客</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">这是一个程序猿的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">路漫漫其修远兮，吾将上下而求索。</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/10/Singleton/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="赵昌吾">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="这是一个程序猿的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Singleton of iOS
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-07-10 16:27:13" itemprop="dateCreated datePublished" datetime="2016-07-10T16:27:13+08:00">2016-07-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-07-31 10:46:41" itemprop="dateModified" datetime="2018-07-31T10:46:41+08:00">2018-07-31</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="单例模式-－-Singleton"><a href="#单例模式-－-Singleton" class="headerlink" title="单例模式 － Singleton"></a>单例模式 － Singleton</h1><p>单例模式确保每个指定的类只存在一个实例对象，并且可以全局访问那个实例</p>
<h2 id="产生的背景／解决的问题"><a href="#产生的背景／解决的问题" class="headerlink" title="产生的背景／解决的问题"></a>产生的背景／解决的问题</h2><ul>
<li>某个类经常被使用，避免其被频繁的创建销毁</li>
<li>共享数据，如NSUserDefault进行本地化<br><img src="/images/Singleton/Singleton_1.png" alt="单例使用原理"></li>
</ul>
<h2 id="主要结构"><a href="#主要结构" class="headerlink" title="主要结构"></a>主要结构</h2><p><img src="/images/Singleton/Singleton_2.png" alt="单例的结构"></p>
<blockquote>
<p>这是一个日志类，有一个属性 (是一个单例对象) 和两个方法 (sharedInstance() 和 init())。第一次调用 sharedInstance() 的时候，instance 属性还没有初始化。所以我们要创建一个新实例并且返回。下一次你再调用 sharedInstance() 的时候，instance 已经初始化完成，直接返回即可。这个逻辑确保了这个类只存在一个实例对象。</p>
</blockquote>
<h2 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h2><p><strong>下面是<a href="https://developer.apple.com/legacy/library/documentation/Cocoa/Conceptual/CocoaFundamentals/CocoaObjects/CocoaObjects.html#//apple_ref/doc/uid/TP40002974-CH4-SW32" target="_blank" rel="noopener">Apple官方文档里面关于单例(Singleton)的示范代码</a>，MRC。</strong>线程安全的问题，这里先不说。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> MyGizmoClass *sharedGizmoManager = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">+ (MyGizmoClass*)sharedManager &#123;</span><br><span class="line">  <span class="keyword">if</span> (sharedGizmoManager == <span class="literal">nil</span>) &#123;</span><br><span class="line">  sharedGizmoManager = [[<span class="keyword">super</span> allocWithZone:<span class="literal">NULL</span>] init];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sharedGizmoManager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">id</span>)allocWithZone:(<span class="built_in">NSZone</span> *)zone &#123;</span><br><span class="line">  <span class="keyword">return</span> [[<span class="keyword">self</span> sharedManager] <span class="keyword">retain</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)<span class="keyword">retain</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)retainCount &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">NSUIntegerMax</span>;  <span class="comment">//denotes an object that cannot be released</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)release &#123;</span><br><span class="line">  <span class="comment">//do nothing</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)autorelease &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><ol>
<li>为单例对象创建一个静态实例，可以写成全局的，也可以在类方法里面实现，并初始化为<code>nil</code>；</li>
<li>实现一个实例构造方法，检查上面声明的静态实例是否为<code>nil</code>，如果是，则创建并返回一个本类的实例；</li>
<li>重写<code>allocWithZone方法</code>，用来保证其他人直接使用<code>alloc</code>和<code>init</code>试图获得一个新实力的时候不产生一个新实例；</li>
<li>适当实现<code>copyWithZone</code>，<code>mutableCopyWithZone</code>，非arc下还需要实现<code>release</code>和<code>autorelease</code>方法。</li>
</ol>
<h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><h4 id="static变量"><a href="#static变量" class="headerlink" title="static变量"></a>static变量</h4><blockquote>
<p> 从面向对象的角度触发，当需要一个数据对象为<strong>整类而非某个对象服务</strong>，同时有力求不破坏类的封装性，既要求此成员隐藏在类的内部，又要求对外不可见的时候，就可以使用static。</p>
</blockquote>
<ul>
<li>这个变量在编译期会对这个变量进行初始化赋值，也就是说这个变量值要么为nil，要么在编译期就可以确定其值，一般情况下，只能用NSString或者基本类型;</li>
<li><code>static</code>变量存储在静态内存中，不属于堆和栈，程序只会分配一次内存，会在程序退出的时候释放。</li>
</ul>
<h4 id="Alloc-amp-amp-AllocWithZone"><a href="#Alloc-amp-amp-AllocWithZone" class="headerlink" title="Alloc &amp;&amp; AllocWithZone"></a>Alloc &amp;&amp; AllocWithZone</h4><ul>
<li>这两个方法是控制内存分配的；</li>
<li>在<code>NSObject</code>这个类的<a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/Foundation/Classes/NSObject_Class/index.html" target="_blank" rel="noopener">官方文档</a>里面，<code>allocWithZone</code>方法介绍说，该方法的参数是被忽略的，正确的做法是传nil或者NULL参数给它。而这个方法之所以存在，是历史遗留原因;</li>
<li><code>[[self alloc] init]</code>调用时，会默认调用<code>+(id)allocWithZone:(NSZone *)zone</code>(这里不讨论什么是<code>NSZone</code>)，为了保持单例类实例的唯一性，需要覆盖所有会生成新的实例的方法，如果有人初始化这个单例类的时候不走<code>[[Class alloc] init]</code>，而是直接<code>allocWithZone</code>，那么这个单例就不再是单例了，所以必须把这个方法也堵上；</li>
</ul>
<h4 id="copyWithZone-amp-amp-mutableCopyWithZone"><a href="#copyWithZone-amp-amp-mutableCopyWithZone" class="headerlink" title="copyWithZone &amp;&amp; mutableCopyWithZone"></a>copyWithZone &amp;&amp; mutableCopyWithZone</h4><ul>
<li>为了避免在<code>copy</code>的时候创建一个新的对象，我们需要重写<code>copyWithZone</code>;</li>
</ul>
<h4 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h4><p><img src="/images/Singleton/Singleton_3.png" alt="线程安全示意图"></p>
<ul>
<li>为了避免出现上图所示的问题，这里我们可以在init的时候加上线程锁；</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)sharedInstance &#123;</span><br><span class="line">  <span class="keyword">static</span> MySingleton *_singleton = <span class="literal">nil</span>;</span><br><span class="line">  <span class="keyword">@synchronized</span>(<span class="keyword">self</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_singleton) &#123;</span><br><span class="line">      _singleton = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> _singleton;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="最终实现代码-ARC"><a href="#最终实现代码-ARC" class="headerlink" title="最终实现代码(ARC)"></a>最终实现代码(ARC)</h3><h4 id="依据上面的说明我们来实现一个单例"><a href="#依据上面的说明我们来实现一个单例" class="headerlink" title="依据上面的说明我们来实现一个单例"></a>依据上面的说明我们来实现一个单例</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)sharedInstance &#123;</span><br><span class="line">  <span class="keyword">@synchronized</span>(<span class="keyword">self</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_instance) &#123;</span><br><span class="line">      _instance = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> _instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)allocWithZone:(<span class="keyword">struct</span> _NSZone *)zone &#123;</span><br><span class="line">  <span class="keyword">return</span> [<span class="keyword">self</span> sharedInstance];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone &#123;</span><br><span class="line">  <span class="keyword">return</span> _instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="我们还可以通过GCD来实现单例"><a href="#我们还可以通过GCD来实现单例" class="headerlink" title="我们还可以通过GCD来实现单例"></a>我们还可以通过GCD来实现单例</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> GCDSingleton *_instance = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)sharedInstance &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">  <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">  _instance = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> _instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)allocWithZone:(<span class="keyword">struct</span> _NSZone *)zone &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">  <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">    _instance = [<span class="keyword">super</span> allocWithZone:zone];</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> _instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone &#123;</span><br><span class="line">  <span class="keyword">return</span> _instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="这里我们介绍一种创建单例的宏-看起来用的很爽，反正我不推荐"><a href="#这里我们介绍一种创建单例的宏-看起来用的很爽，反正我不推荐" class="headerlink" title="这里我们介绍一种创建单例的宏(看起来用的很爽，反正我不推荐)"></a>这里我们介绍一种创建单例的宏(看起来用的很爽，反正我不推荐)</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .h文件</span></span><br><span class="line"><span class="meta">#define CHSingletonH(name) + (instancetype)shared##name;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// .m文件</span></span><br><span class="line"><span class="meta">#define CHSingletonM(name) \</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">id</span> _instance; \</span><br><span class="line">\</span><br><span class="line">+ (<span class="keyword">instancetype</span>)allocWithZone:(<span class="keyword">struct</span> _NSZone *)zone \</span><br><span class="line">&#123; \</span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken; \</span><br><span class="line">  <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123; \</span><br><span class="line">  _instance = [<span class="keyword">super</span> allocWithZone:zone]; \</span><br><span class="line">  &#125;); \</span><br><span class="line">    <span class="keyword">return</span> _instance; \</span><br><span class="line">  &#125; \</span><br><span class="line">\</span><br><span class="line">+ (<span class="keyword">instancetype</span>)shared<span class="meta">##name \</span></span><br><span class="line">&#123; \</span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken; \</span><br><span class="line">  <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123; \</span><br><span class="line">    _instance = [[<span class="keyword">self</span> alloc] init]; \</span><br><span class="line">    &#125;); \</span><br><span class="line">    <span class="keyword">return</span> _instance; \</span><br><span class="line">&#125; \</span><br><span class="line">\</span><br><span class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone \</span><br><span class="line">&#123; \</span><br><span class="line">  <span class="keyword">return</span> _instance; \</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>====================用法=====================</em></strong></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MacroSingleton</span> : <span class="title">NSObject</span></span></span><br><span class="line">CHSingletonH(MacroSingleton)</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MacroSingleton</span></span></span><br><span class="line">CHSingletonM(MacroSingleton)</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：用的时候后面没有<code>&quot;;&quot;</code></p>
<h4 id="偷懒的方法有很多种，比如下面"><a href="#偷懒的方法有很多种，比如下面" class="headerlink" title="偷懒的方法有很多种，比如下面"></a>偷懒的方法有很多种，比如下面</h4><p>Xcode4 引入了一个新<code>feature</code>: <code>code snippets</code>，具体用法自行查找。下面提供两篇博客的链接</p>
<ul>
<li><a href="http://blog.devtang.com/2012/02/04/use-git-to-manage-code-snippets/" target="_blank" rel="noopener">使用 Git 来管理 Xcode 中的代码片段</a></li>
<li><a href="http://nshipster.cn/xcode-snippets/" target="_blank" rel="noopener">Xcode Snippets</a></li>
</ul>
<h3 id="Swift实现单例的进化之路"><a href="#Swift实现单例的进化之路" class="headerlink" title="Swift实现单例的进化之路"></a>Swift实现单例的进化之路</h3><h4 id="先仿照OC的实现方式进行，相传这是最丑的方法"><a href="#先仿照OC的实现方式进行，相传这是最丑的方法" class="headerlink" title="先仿照OC的实现方式进行，相传这是最丑的方法"></a>先仿照OC的实现方式进行，相传这是最丑的方法</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SwiftSingleton</span>: <span class="title">NSObject</span> </span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">var</span> <span class="title">sharedInstance</span>: <span class="title">SwiftSingleton</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">Static</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> onceToken: dispatch_once_t = <span class="number">0</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> instance: <span class="type">SwiftSingleton</span>? = <span class="literal">nil</span></span><br><span class="line">  &#125;</span><br><span class="line">  dispatch_once(&amp;<span class="type">Static</span>.onceToken) &#123;</span><br><span class="line">    <span class="type">Static</span>.instance = <span class="type">SwiftSingleton</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="type">Static</span>.instance!</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>因为 Swift 1.2 之前并不支持存储类型的类属性，所以我们需要使用一个 struct 来存储类型变量。</p>
</blockquote>
<h4 id="Swift-里用-let-保证线程安全"><a href="#Swift-里用-let-保证线程安全" class="headerlink" title="Swift 里用 let 保证线程安全"></a>Swift 里用 <code>let</code> 保证线程安全</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SwiftSingleton</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">var</span> <span class="title">sharedManager</span> : <span class="title">SwiftSingleton</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">Static</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">let</span> sharedInstance : <span class="type">SwiftSingleton</span> = <span class="type">MyManager</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Static</span>.sharedInstance</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Swift-1-2-之前的最佳实践"><a href="#Swift-1-2-之前的最佳实践" class="headerlink" title="Swift 1.2 之前的最佳实践"></a>Swift 1.2 之前的最佳实践</h4><p>由于 Swift 1.2 之前 class 不支持存储式的 property，我们想要使用一个只存在一份的属性时，就只能将其定义在全局的 scope 中。值得庆幸的是，在 Swift 中是有访问级别的控制的，我们可以在变量定义前面加上 private 关键字，使这个变量只在当前文件中可以被访问。这样我们就可以写出一个没有嵌套的，语法上也更简单好看的单例了：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">let</span> sharedInstance = <span class="type">MyManager</span>()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyManager</span>  </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">var</span> <span class="title">sharedManager</span> : <span class="title">MyManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sharedInstance</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Swift-1-2-之后的推荐用法"><a href="#Swift-1-2-之后的推荐用法" class="headerlink" title="Swift 1.2 之后的推荐用法"></a>Swift 1.2 之后的推荐用法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class SwiftSingleton  &#123;</span><br><span class="line">  static let sharedInstance = SwiftSingleton()</span><br><span class="line">  private init() &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在初始化类变量的时候，Apple 将会把这个初始化包装在一次 swift_once_block_invoke 中，以保证它的唯一性。另外，我们在这个类型中加入了一个私有的初始化方法，来覆盖默认的公开初始化方法，这让项目中的其他地方不能够通过 init 来生成自己的 MyManager 实例，也保证了类型单例的唯一性</p>
<h2 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h2><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li>提供了对唯一实例的受控访问。</li>
<li>由于在系统内存中只存在一个对象，因此可以节约系统资源，对于一些需要频繁创建和销毁的对象单例模式无疑可以提高系统的性能。</li>
<li>因为单例模式的类控制了实例化的过程，所以类可以更加灵活修改实例化过程。</li>
</ul>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>由于单利模式中没有抽象层，因此单例类的扩展有很大的困难。</li>
<li>单例类的职责过重，在一定程度上违背了“单一职责原则”。</li>
</ul>
<h2 id="注意事项；"><a href="#注意事项；" class="headerlink" title="注意事项；"></a>注意事项；</h2><ul>
<li>不要继承单例类</li>
<li>先创建子类永远是子类对象</li>
<li>先创建父类永远是父类对象</li>
</ul>
<h2 id="应用实例"><a href="#应用实例" class="headerlink" title="应用实例"></a>应用实例</h2><ul>
<li>应用本身就是一个单例<code>[UIApplication sharedApplication]</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UIWindow *window = [UIApplication sharedApplication].keyWindow;</span><br><span class="line">UINavigationController * navigation = (UINavigationController *)window.rootViewController;</span><br></pre></td></tr></table></figure>
<ul>
<li>我们常用<code>NSUserDefaults</code>本地化一些数据</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSUserDefaults</span> *userDefaults = [<span class="built_in">NSUserDefaults</span> standardUserDefaults];</span><br><span class="line">[userDefaults setObject:obj forKey:key];</span><br><span class="line">[userDefaults objectForKey:key];</span><br></pre></td></tr></table></figure>
<ul>
<li>网络请求在我们的应用开发中我觉得是最常用的需要代码复用的部分，因为他使用次数多，且代码都差不多，不受别的模块代码干扰，即低耦合,高内聚。我们进行网络请求要先创建一个<code>manager</code>，就是说每次请求我们都需要创建<code>manager</code>，但是频繁的创建销毁很浪费系统资源，完全没有必要，因此我们就可以将<code>manager</code>封装成一个单例。在<a href="https://github.com/AFNetworking/AFNetworking" target="_blank" rel="noopener">AFNetworkingDemo</a>中就是将<code>AFHTTPSessionManager</code>封装成一个单例。</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)sharedClient &#123;</span><br><span class="line">  <span class="keyword">static</span> AFAppDotNetAPIClient *_sharedClient = <span class="literal">nil</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">  <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">  _sharedClient = [[AFAppDotNetAPIClient alloc] initWithBaseURL:[<span class="built_in">NSURL</span> URLWithString:AFAppDotNetAPIBaseURLString]];</span><br><span class="line">  _sharedClient.securityPolicy = [AFSecurityPolicy policyWithPinningMode:AFSSLPinningModeNone];</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> _sharedClient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>[NSNotificationCenter defaultCenter]</code></li>
</ul>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
            <a href="/tags/Singleton/" rel="tag"># Singleton</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/07/10/使用oh my zsh配置终端/" rel="prev" title="使用「oh my zsh」配置MAC终端">
                使用「oh my zsh」配置MAC终端 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">赵昌吾</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">3</span>
                    <span class="site-state-item-name">分类</span>
                  
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">10</span>
                    <span class="site-state-item-name">标签</span>
                  
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#单例模式-－-Singleton"><span class="nav-number">1.</span> <span class="nav-text">单例模式 － Singleton</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#产生的背景／解决的问题"><span class="nav-number">1.1.</span> <span class="nav-text">产生的背景／解决的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#主要结构"><span class="nav-number">1.2.</span> <span class="nav-text">主要结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实现方式"><span class="nav-number">1.3.</span> <span class="nav-text">实现方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#步骤"><span class="nav-number">1.3.1.</span> <span class="nav-text">步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#说明"><span class="nav-number">1.3.2.</span> <span class="nav-text">说明</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#static变量"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">static变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Alloc-amp-amp-AllocWithZone"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">Alloc &amp;&amp; AllocWithZone</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#copyWithZone-amp-amp-mutableCopyWithZone"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">copyWithZone &amp;&amp; mutableCopyWithZone</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#线程安全"><span class="nav-number">1.3.2.4.</span> <span class="nav-text">线程安全</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#最终实现代码-ARC"><span class="nav-number">1.3.3.</span> <span class="nav-text">最终实现代码(ARC)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#依据上面的说明我们来实现一个单例"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">依据上面的说明我们来实现一个单例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#我们还可以通过GCD来实现单例"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">我们还可以通过GCD来实现单例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#这里我们介绍一种创建单例的宏-看起来用的很爽，反正我不推荐"><span class="nav-number">1.3.3.3.</span> <span class="nav-text">这里我们介绍一种创建单例的宏(看起来用的很爽，反正我不推荐)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#偷懒的方法有很多种，比如下面"><span class="nav-number">1.3.3.4.</span> <span class="nav-text">偷懒的方法有很多种，比如下面</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Swift实现单例的进化之路"><span class="nav-number">1.3.4.</span> <span class="nav-text">Swift实现单例的进化之路</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#先仿照OC的实现方式进行，相传这是最丑的方法"><span class="nav-number">1.3.4.1.</span> <span class="nav-text">先仿照OC的实现方式进行，相传这是最丑的方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Swift-里用-let-保证线程安全"><span class="nav-number">1.3.4.2.</span> <span class="nav-text">Swift 里用 let 保证线程安全</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Swift-1-2-之前的最佳实践"><span class="nav-number">1.3.4.3.</span> <span class="nav-text">Swift 1.2 之前的最佳实践</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Swift-1-2-之后的推荐用法"><span class="nav-number">1.3.4.4.</span> <span class="nav-text">Swift 1.2 之后的推荐用法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优缺点"><span class="nav-number">1.4.</span> <span class="nav-text">优缺点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#优点"><span class="nav-number">1.4.1.</span> <span class="nav-text">优点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#缺点"><span class="nav-number">1.4.2.</span> <span class="nav-text">缺点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注意事项；"><span class="nav-number">1.5.</span> <span class="nav-text">注意事项；</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#应用实例"><span class="nav-number">1.6.</span> <span class="nav-text">应用实例</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">赵昌吾</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Muse</a> v6.3.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
